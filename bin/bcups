#!/bin/bash

RED='\e[41m'
BLUE='\e[44m'
ORANGE='\e[46m'
NC='\e[0m'
browser='elinks'
printers=$(lpstat -p -d | awk '/printer/ {print $2}')
enabled_printers=$(lpstat -p -d | awk '/enabled/ {print $2}')
    
function webinterface {
  $browser http://localhost:631
}

function set_default_printer {
  lpoptions -d $(echo $printers | fzf -e --reverse --prompt='Select new default printer >')
  echo ""
  echo ""
  echo "The new default printer has been set"
}

function print_file {
  grep -q "Default" ~/.cups/lpoptions && \
  lpr $(fzf -m --reverse --prompt='Select the files to print (use TAB to mark files for printing) >') || \
  lpr -P $(echo $printers | fzf -e --reverse --prompt='Select the printer to use >') $(fzf -m --reverse --prompt='Select the files to print (use TAB to mark files for printing) >')
  echo ""
  echo ""
  echo "Printing now"
  sleep 3
}

function select_scanner {
  scanimage -L 2> /dev/null | fzf -e --reverse --prompt='Searching for scanners... Select one >' | awk '{print substr($2, 2, length($2) - 2)}'
}

function set_default_scanner {
  default_scan=$(scanimage -L 2> /dev/null | \
  fzf -e --reverse --prompt='Searching for scanners... Select new default >' | \
  awk '{print $2} {print substr($2, 2, length($2) - 2)}')
  echo "export SANE_DEFAULT_DEVICE=$(default_scan)" >> $HOME/.profile
  SANE_DEFAULT_DEVICE=$(default_scan)
}

function select_filetype {
PS3="Which filetype should be used? "
# Gather the results in an array.
filetypes=("pnm" "tiff" "png" "jpeg")

select pick in "${filetypes[@]}"
do
	case $pick in
		*)	echo $pick	
			break
	esac
done
}

function scan {
  echo "What name shall be given to the scanned file?"
  read filename
  eval filetype=$(select_filetype)
  scanner=$(select_scanner)
  scanimage -p -d $scanner --format=$filetype > $filename.$filetype
}

function default_scan {
  echo "What name shall be given to the scanned file?"
  read filename
  eval filetype=$(select_filetype)
  scanimage -p --format=$filetype > $filename.$filetype
}


function main {
    while true; do
    clear
    echo ""
    echo -e "                 ::Printers and scanners::  "
    echo -e " ┌─────────────────────────────────────────────────────────────┐"
    echo -e " │    1   Manage Printers            2   Print files           │"
    echo -e " │    3   Set default printer        4   List printers         │"
    echo -e " │    5   Set default scanner        6   Scan                  │"    
    echo -e " │    7   List scanners              8   Scan using defaults   │"    
    echo -e " └─────────────────────────────────────────────────────────────┘"
    echo -e "             Select a number - 0 Exit "
    echo ""
    read -s -n1 choix
    case $choix in
        1)
            echo
            webinterface
            echo ""
            ;;
        2)
            echo
            print_file
            echo ""
            ;;
        3)
            echo
            set_scanner
            echo ""
            ;;
        4)
            echo
            lpstat -p -d
            echo ""
            ;;
        5)
            echo
            set_default_scanner
            echo ""
            ;;
        6)
            echo
            scan
            echo ""
            ;;
        7)
            echo
            scanimage -L 2> /dev/null
            echo ""
            ;;
        8)
            echo
            default_scan
            echo ""
            ;;
        0)
            clear && exit
            read
            ;;
        *)
            echo -e "$RED Wrong option $NC"
            echo "Wait and try again later..."
            echo ""
            sleep 3
            clear
            ;;
    esac
    done
}

main
