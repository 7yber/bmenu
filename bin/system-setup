#!/bin/bash

RED='\e[41m'
BLUE='\e[44m'
ORANGE='\e[46m'
NC='\e[0m'
function shell_chooser {
PS3="Which shell do you wish to use as default? "
# Gather the results in an array.
shells=("zsh" "bash" "fish" "dash" "cancel")

select pick in "${shells[@]}"
do
	case $pick in
		zsh)
			echo ""
			echo "Z shell. Advanced and versatile shell with supreme configuration options and tab completion. Master of all trades, jack of none, but really needs configuration."
			echo ""
			echo ""
			sudo pacman -Syu zsh zsh-completions command-not-found
			echo ""
			echo ""
			echo "check oh-my-zsh or builtin configuration tool for configurations"
			echo "you migh also like zsh-history-substring search or zsh-syntax-highlighting"
			echo ""
			echo ""
			chsh -s /usr/bin/zsh
			break
			;;		
		bash)
			echo ""
			echo ""
			echo "Bourne again shell. Standard for most linux systems. Respectable choice for any use. Jack of all trades, master of none."
			echo ""
			echo ""
			sudo pacman -Syu bash bash-completion command-not-found
			echo ""
			chsh -s /bin/bash
			break
			;;		
		fish)
			echo ""
			echo ""
			echo "Friendly interactive shell. Bad for scripting, great for interactive use without much configuration required."
			echo ""
			echo ""
			sudo pacman -Syu fish command-not-found
			chsh -s /usr/bin/fish
			echo ""
			break
			;;		
		dash)
			echo ""
			echo ""
			echo "Debian almquist shell. Super light and feature free. Great for scripting and fast startup, entirely unsuitable for interactive use."
			sudo pacman -Syu dash
			chsh -s /usr/dash
			break
			;;		
		cancel)
			break
	esac
done
}

function displaymanager {
PS3="Which displaymanager do you wish to use? "
# Gather the results in an array.
dms=("lightdm" "kdm" "gdm" "lxdm" "mdm" "slim" "sddm" "cancel")

select pick in "${dms[@]}"
do
	case $pick in
		slim)
			if ! [[ -d /run/openrc ]] ; then
			sudo pacman -Sy slim slim-themes && sudo systemctl enable slim.service -f
			else
			sudo pacman -Sy slim slim-themes && sudo sed -i "s/$(grep "DISPLAYMANAGER=" /etc/conf.d/xdm)/DISPLAYMANAGER=\"slim\"/g" /etc/conf.d/xdm
			sudo rc-update add xdm default
			break
			;;		
		lightdm)
			if ! [[ -d /run/openrc ]] ; then
			sudo pacman -Sy lightdm lightdm-another-gtk-greeter lightdm-another-gtk-greeter-themes accountsservice \
			&& sudo systemctl enable lightdm.service -f && sudo systemctl enable accounts-daemon && \
			sudo nano /etc/lightdm/lightdm.conf
			else
			sudo pacman -Sy lightdm lightdm-another-gtk-greeter lightdm-another-gtk-greeter-themes accountsservice \
			&& sudo sed -i "s/$(grep "DISPLAYMANAGER=" /etc/conf.d/xdm)/DISPLAYMANAGER=\"lightdm\"/g" /etc/conf.d/xdm && \
			sudo nano /etc/lightdm/lightdm.conf
			sudo rc-update add xdm default
			break
			;;		
		sddm)
			if ! [[ -d /run/openrc ]] ; then
			sudo pacman -Sy sddm && sudo systemctl enable sddm.service -f
			else
			sudo pacman -Sy sddm && sudo sed -i "s/$(grep "DISPLAYMANAGER=" /etc/conf.d/xdm)/DISPLAYMANAGER=\"sddm\"/g" /etc/conf.d/xdm
			sudo rc-update add xdm default
			break
			;;		
		mdm)
			if ! [[ -d /run/openrc ]] ; then
			sudo pacman -Sy mdm && sudo systemctl enable mdm.service -f
			else
			sudo pacman -Sy mdm-nosystemd && sudo sed -i "s/$(grep "DISPLAYMANAGER=" /etc/conf.d/xdm)/DISPLAYMANAGER=\"mdm\"/g" /etc/conf.d/xdm
			sudo rc-update add xdm default
			break
			;;		
		lxdm)
			if ! [[ -d /run/openrc ]] ; then
			sudo pacman -Sy lxdm && sudo systemctl enable lxdm.service -f
			else
			sudo pacman -Sy lxdm-consolekit && sudo sed -i "s/$(grep "DISPLAYMANAGER=" /etc/conf.d/xdm)/DISPLAYMANAGER=\"lxdm\"/g" /etc/conf.d/xdm
			break
			;;		
		gdm)
			if ! [[ -d /run/openrc ]] ; then
			sudo pacman -Sy gdm3setup && sudo systemctl enable gdm.service -f
			else
			echo "gdm will not work with openrc"
			break
			;;		
		kdm)
			if ! [[ -d /run/openrc ]] ; then
			sudo pacman -Sy kdebase-workspace archlinux-themes-kdm && sudo systemctl enable kdm.service -f
			else
			sudo pacman -Sy kdebase-workspace-consolekit archlinux-themes-kdm && sudo sed -i "s/$(grep "DISPLAYMANAGER=" /etc/conf.d/xdm)/DISPLAYMANAGER=\"kdm\"/g" /etc/conf.d/xdm
			sudo rc-update add xdm default 
			break
			;;		
		cancel)
			break
	esac
done
}

function disk_utils {
PS3="Select tool to use? "
# Gather the results in an array.
tools=("cfdisk" "cgdisk" "gdisk" "parted" "gparted" "gnome-disks")

select pick in "${tools[@]}"
do
	case $pick in
		cfdisk)
			sudo cfdisk
			break
			;;		
		cgdisk)
			sudo cgdisk
			break
			;;		
		gdisk)
			sudo gdisk
			break
			;;		
		parted)
			sudo parted
			break
			;;		
		gparted)
			sudo gparted
			break
			;;		
		gnome-disks)
			sudo gnome-disks
			break
			;;		
		cancel)
			break
	esac
done
}

function hibernation_setup {
	sudo hibernator
	echo "Enable delayed hibernation service? (y/n)"
	read -s -n1 choix
    case $choix in
	    y)
    	sudo pacman -Syu delayed-hibernation
    	break
    	;;
    	*)
    	break
    	;; 
esac
}

function dm_detect {
if [ $(cat /proc/1/comm) = "systemd" ]; then
	for displaymanager in kdm gdm sddm lightdm lxdm slim; do
		systemctl status $displaymanager.service | grep -q enabled && echo $displaymanager
	done
else
	grep 'DISPLAYMANAGER=' /etc/conf.d/xdm | cut -d \" -f 2
fi
}

function choose_session {
PS3="Which session do you wish to use as default? "
# Gather the results in an array.
session=($(ls /usr/share/xsessions/) "cancel")

select pick in "${dms[@]}"
do
	case $pick in
		*)
			echo $pick
			break
			;;			
		cancel)
			break
	esac
done
}

function autologger {
	dm=$(dm_detect)
	session=$(choose_session)
	eval user=$(whoami)
	case dm in 
			slim)
			sudo sed -i '/autologin/s/^#//g' /etc/slim.conf && sudo sed -i '/defaultuser/s/^#//g' /etc/slim.conf
			sudo sed -i "s/simone/$user/g" /etc/slim.conf
			break
			;;		
		lightdm)
			sudo sed -i "s/^autologin-user=*/autologin-user=$user/g" /etc/lightdm.conf
			sudo sed -i 's/^autologin-user-timeout=*/autologin-user-timeout=0/g' /etc/lightdm.conf
			sudo groupadd -r autologin
			sudo gpasswd -a $user autologin						
			sudo nano /etc/lightdm.conf
			break
			;;		
		sddm)
			sudo sddm --example-config > /etc/sddm.conf
			sudo sed -i "s/^User=/User=$user/g" /etc/sddm.conf
			sudo sed -i "s/^Session/Session=$session/g" /etc/slim.conf
			break
			;;		
		mdm)
			sudo sed -i "s/^AutomaticLogin=*/AutomaticLogin=$user/g" /etc/mdm.conf
			sudo sed -i 's/^AutomaticLoginEnable=*/AutomaticLoginEnable=true/g' /etc/mdm.conf
			sudo sed -i 's/^TimedLoginEnable=*/TimedLoginEnable=true/g' /etc/mdm.conf
			sudo sed -i 's/^TimedLogin=*/TimedLoginEnable=$user/g' /etc/mdm.conf
			sudo sed -i 's/^TimedLoginDelay=*/TimedLoginDelay=0/g' /etc/mdm.conf
			sudo nano /etc/mdm/mdm.conf
			break
			;;		
		lxdm)
			sudo sed -i "1s/^/autologin=$user /" /etc/lxdm/lxdm.conf
			sudo nano /etc/lxdm/lxdm.conf
			break
			;;		
		gdm)
			sudo sed -i "s/^AutomaticLogin=*/AutomaticLogin=$user/g" /etc/gdm/custom.conf
			sudo sed -i 's/^AutomaticLoginEnable=*/AutomaticLoginEnable=true/g' /etc/gdm/custom.conf
			sudo sed -i 's/^TimedLoginEnable=*/TimedLoginEnable=true/g' /etc/gdm/custom.conf
			sudo sed -i 's/^TimedLogin=*/TimedLoginEnable=$user/g' /etc/gdm/custom.conf
			sudo sed -i 's/^TimedLoginDelay=*/TimedLoginDelay=0/g' /etc/gdm/custom.conf
			break
			;;		
		kdm)
			sudo sed -i "s/^AutoLoginUser=*/AutoLoginUser=$user/g" /usr/kde/*/share/config/kdm/kdmrc
			sudo sed -i "s/^AutoLoginEnable=*/AutoLoginEnable=true/g" /usr/kde/*/share/config/kdm/kdmrc
			break
			;;		
		*)
			if ! [[ -d /run/openrc ]] ; then
				sudo pacman -Syu xlogin && sudo systemctl enable xlogin@$(whoami)
			else
				echo -e "No support for setting up autologin without displaymanager on openrc. Yet."
			fi
			;;
	esac
}

    while true; do
    clear
    echo ""
    echo -e "                            ::Setup:: "
    echo -e " ┌─────────────────────────────────────────────────────────────┐"
    echo -e " │    1   Enable hibernation        2   Choose Display manager │"
    echo -e " │    3   Enable autologin          4   Install AUR support    │"
    echo -e " │    5   Choose shell              6   Disk utility           │"    
    echo -e " │    7   Install printer support   8   Recover files          │"
    echo -e " └─────────────────────────────────────────────────────────────┘"
    echo -e "          Select an item     -      0   Exit "
    echo ""
    read -s -n1 choix
    case $choix in
        1)
            echo
            hibernation_setup
            echo ""
            ;;
        2)
            echo
            displaymanager
            echo ""
            ;;
        3)
            echo
            autologger
            echo ""
            ;;
        4)
            echo
            sudo pacman -Syu base-devel yaourt
            echo ""
            ;;
        5)
            echo
            echo -e "Your current shell is $(echo $SHELL)"
            shell_chooser
            echo ""
            ;;
        6)
            echo
            disk_utils
            echo ""
            ;;
        7)
            echo
            sudo pacman -Syu manjaro-printers sane
            echo ""
            ;;
        8)
            echo
            photorec
            echo ""
            ;;
        9)
            echo
            disk_utils
            echo ""
            ;;
        0)
            clear && exit
            read
            ;;
        *)
            echo -e "$RED Wrong option $NC"
            echo "Wait and try again later..."
            echo ""
            sleep 3
            clear
            ;;
    esac
    done
