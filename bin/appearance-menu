#!/bin/bash

RED='\e[41m'
BLUE='\e[44m'
ORANGE='\e[46m'
NC='\e[0m'

if ! [ -f "$HOME/.gtkrc-2.0" ]; then
	cat > $HOME/.gtkrc-2.0 <<EOL

include "/home/matti/.gtkrc-2.0.mine"
gtk-theme-name="Adwaita"
gtk-icon-theme-name="Adwaita"
gtk-font-name="DejaVu Sans 12"
gtk-cursor-theme-name="Adwaita"
gtk-cursor-theme-size=18
gtk-toolbar-style=GTK_TOOLBAR_ICONS
gtk-toolbar-icon-size=GTK_ICON_SIZE_LARGE_TOOLBAR
gtk-button-images=1
gtk-menu-images=0
gtk-enable-event-sounds=0
gtk-enable-input-feedback-sounds=0
gtk-xft-antialias=1
gtk-xft-hinting=1
gtk-xft-hintstyle="hintmedium"
gtk-xft-rgba="none"

EOL
fi

if ! [ -f "$HOME/.config/gtk-3.0/settings.ini" ]; then
	cat > $HOME/.config/gtk-3.0/settings.ini <<EOL
[Settings]
gtk-application-prefer-dark-theme=1
gtk-theme-name=Adwaita
gtk-icon-theme-name=Adwaita
gtk-font-name=DejaVu Sans 12
gtk-cursor-theme-name=Adwaita
gtk-cursor-theme-size=18
gtk-toolbar-style=GTK_TOOLBAR_ICONS
gtk-toolbar-icon-size=GTK_ICON_SIZE_LARGE_TOOLBAR
gtk-button-images=1
gtk-menu-images=0
gtk-enable-event-sounds=0
gtk-enable-input-feedback-sounds=0
gtk-xft-antialias=1
gtk-xft-hinting=1
gtk-xft-hintstyle=hintmedium
gtk-xft-rgba=none
gtk-decoration-layout=:menu,appmenu,close

EOL
fi

if ! [ -f "$HOME/.icons/default/index.theme" ]; then
	mkdir -r $HOME/.icons/default/
	cat > $HOME/.icons/default/index.theme <<EOL
# This file is written by LXAppearance. Do not edit.
[Icon Theme]
Name=Default
Comment=Default Cursor Theme
Inherits=Adwaita
EOL
fi

function set_gtk2_theme {
	new_theme="$@"
	cp $HOME/.gtkrc-2.0 $HOME/.gtkrc-2.0.bak && sed -i "s/$(grep "gtk-theme-name" .gtkrc-2.0)/gtk-theme-name=\"$new_theme\"/g" .gtkrc-2.0
}

function choose_gtk2_theme {
PS3="Choose new gtk2 theme: "
# Gather the results in an array.
gtk2_themes=($(find /usr/share/themes -type d -name "gtk-2.0" | awk -F'/' '{print $5}') "proceed" "cancel")

select pick in "${gtk2_themes[@]}"
do
	case $pick in
		proceed)
			break
			;;
		cancel)
			exit
			;;		
		*)	
			picks+=("$pick")
			break
			;;		
	esac
done

if [[ $picks ]]; then
    printf 'Setting theme to %s\n' "${picks[*]}"
    set_gtk2_theme "${picks[@]}"
    picks=()
fi
}

function set_gtk3_theme {
	new_theme="$@"
	cp $HOME/.config/gtk-3.0/settings.ini $HOME/.config/gtk-3.0/settings.ini.bak && sed -i "s/$(grep "gtk-theme-name" $HOME/.config/gtk-3.0/settings.ini)/gtk-theme-name=$new_theme/g" $HOME/.config/gtk-3.0/settings.ini
}

function choose_gtk3_theme {
PS3="Choose new gtk3 theme: "
# Gather the results in an array.
gtk3_themes=($(find /usr/share/themes -type d -name "gtk-3.0" | awk -F'/' '{print $5}') "proceed" "cancel")

select pick in "${gtk3_themes[@]}"
do
	case $pick in
		proceed)
			break
			;;
		cancel)
			exit
			;;		
		*)	
			picks+=("$pick")
			break
			;;		
	esac
done

if [[ $picks ]]; then
    printf 'Setting theme to %s\n' "${picks[*]}"
    set_gtk3_theme "${picks[@]}"
    picks=()
fi
}

function set_icon_theme {
	new_theme="$@"
	cp $HOME/.config/gtk-3.0/settings.ini $HOME/.config/gtk-3.0/settings.ini.bak && sed -i "s/$(grep "gtk-icon-theme-name" $HOME/.config/gtk-3.0/settings.ini)/gtk-icon-theme-name=$new_theme/g" $HOME/.config/gtk-3.0/settings.ini
	cp $HOME/.gtkrc-2.0 $HOME/.gtkrc-2.0.bak && sed -i "s/$(grep "gtk-icon-theme-name" $HOME/.gtkrc-2.0)/gtk-icon-theme-name=\"$new_theme\"/g" $HOME/.gtkrc-2.0	
}

function choose_icon_theme {
PS3="Choose new icon theme: "
# Gather the results in an array.
icon_themes=($(find /usr/share/icons -type f -name "index.theme" | awk -F'/' '{print $5}') "proceed" "cancel")

select pick in "${icon_themes[@]}"
do
	case $pick in
		proceed)
			break
			;;
		cancel)
			exit
			;;		
		*)	
			picks+=("$pick")
			break
			;;		
	esac
done

if [[ $picks ]]; then
    printf 'Setting theme to %s\n' "${picks[*]}"
    set_icon_theme "${picks[@]}"
    picks=()
fi
}

function set_pointer_theme {
	new_theme="$@"
	cp $HOME/.icons/default/index.theme $HOME/.icons/default/index.theme.bak && sed -i "s/$(grep "Inherits" $HOME/.icons/default/index.theme)/Inherits=$new_theme/g" $HOME/.icons/default/index.theme
	cp $HOME/.config/gtk-3.0/settings.ini $HOME/.config/gtk-3.0/settings.ini.bak && sed -i "s/$(grep "gtk-cursor-theme-name" $HOME/.config/gtk-3.0/settings.ini)/gtk-cursor-theme-name=$new_theme/g" $HOME/.config/gtk-3.0/settings.ini
	cp $HOME/.gtkrc-2.0 $HOME/.gtkrc-2.0.bak && sed -i "s/$(grep "gtk-cursor-theme-name" $HOME/.gtkrc-2.0)/gtk-cursor-theme-name=\"$new_theme\"/g" $HOME/.gtkrc-2.0
}

function choose_pointer_theme {
PS3="Choose new pointer theme: "
# Gather the results in an array.
pointer_themes=($(find /usr/share/icons -type d -name "cursors" | awk -F'/' '{print $5}' | sed 's/-Cursor//g') "proceed" "cancel")

select pick in "${pointer_themes[@]}"
do
	case $pick in
		proceed)
			break
			;;
		cancel)
			exit
			;;		
		*)	
			picks+=("$pick")
			break
			;;		
	esac
done

if [[ $picks ]]; then
    printf 'Setting theme to %s\n' "${picks[*]}"
    set_pointer_theme "${picks[@]}"
    picks=()
fi
}

function set_font {
	new_theme="$@"
	cp $HOME/.config/gtk-3.0/settings.ini $HOME/.config/gtk-3.0/settings.ini.bak && sed -i "s/$(grep "gtk-font-name" $HOME/.config/gtk-3.0/settings.ini)/gtk-font-name=$new_theme/g" $HOME/.config/gtk-3.0/settings.ini
	cp $HOME/.gtkrc-2.0 $HOME/.gtkrc-2.0.bak && sed -i "s/$(grep "gtk-font-name" $HOME/.gtkrc-2.0)/gtk-font-name=\"$new_theme\"/g" $HOME/.gtkrc-2.0	
}

function choose_font {
new_font=$(fc-list : family | fzf -e --reverse --prompt="< Choose new font to use >")
echo "  Input the size of the font"
read font_size

set_font $new_font $font_size
}
function toggle_dark_theme {
	grep -q "gtk-application-prefer-dark-theme=1" $HOME/.config/gtk-3.0/settings.ini && \
	sed -i "s/gtk-application-prefer-dark-theme=1/gtk-application-prefer-dark-theme=0/g" $HOME/.config/gtk-3.0/settings.ini || \
	sed -i "s/gtk-application-prefer-dark-theme=0/gtk-application-prefer-dark-theme=1/g" $HOME/.config/gtk-3.0/settings.ini
}

function main {
    while true; do
    clear
    echo ""
    echo -e "                              ::Appearance::  "
    echo -e " ┌────────────────────────────────────────────────────────────────┐"
    echo -e " │    1   Set gtk2 theme               2   Set gtk3 theme         │"
    echo -e " │    3   Set font                     4   Set icon theme         │"
    echo -e " │    5   Toggle dark theme            6   Set pointer theme      │"    
    echo -e " │    7   Edit gtk2 settings           8   Edit gtk3 settings     │" 
    echo -e " │    9   Edit Xresources              0   Exit                   │"   
    echo -e " └────────────────────────────────────────────────────────────────┘"
        echo -e "             Select a number and press [Enter] "
    echo ""
    read -s -n1 choix
    case $choix in
        1)
            echo
            choose_gtk2_theme
            echo ""
            ;;
        2)
            echo
            choose_gtk3_theme
            echo ""
            ;;
        3)
            echo
            choose_font
            echo ""
            ;;
        4)
            echo
            choose_icon_theme
            echo ""
            ;;
        5)
            echo
            toggle_dark_theme
            echo ""
            ;;
        6)
            echo
            choose_pointer_theme
            echo ""
            ;;
        7)
            echo
            nano $HOME/.gtkrc-2.0
            echo ""
            ;;
        8)
            echo
            nano $HOME/.config/gtk-3.0/settings.ini
            echo ""
            ;;
        9)
            echo
            nano $HOME/.Xresources
            echo ""
            ;;
        0)
            clear && exit
            read
            ;;
        *)
            echo -e "$RED Unknown option $NC"
            echo "Wait and try again later..."
            echo ""
            sleep 3
            clear
            ;;
    esac
    done
}

main
